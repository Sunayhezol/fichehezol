<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fiche D&D 2024</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f5f5f5; margin: 0; padding: 1rem; }
    .container { max-width: 900px; margin: auto; }
    .card { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 0.5rem; }
    h2 { margin: 0.2rem 0 0.8rem; text-align: center; }
    input { width: 100%; padding: 0.55rem; margin: 0.2rem 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    button { margin-top: 0.5rem; padding: 0.55rem 1rem; border: none; border-radius: 8px; background: #1976d2; color: white; font-weight: 600; cursor: pointer; }
    button:hover { background: #125ca5; }
    .muted { color: #555; font-size: 0.9rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .toolbar { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; justify-content: center; }
    .secondary { background: #eee; color: #222; }
    .danger { background: #d32f2f; }
    .danger:hover { background: #b71c1c; }
    .file-input { display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📜 Fiche de Personnage D&D 2024</h1>
    <p class="muted" id="status">Sauvegarde automatique activée ✅</p>

    <div class="card toolbar">
      <button id="exportBtn">📤 Exporter la fiche (JSON)</button>
      <label class="file-input">
        <input type="file" id="importInput" accept="application/json" style="display:none">
        <button id="importBtn" class="secondary">📥 Importer une fiche (JSON)</button>
      </label>
      <button id="resetBtn" class="danger">🧹 Réinitialiser</button>
    </div>

    <!-- Bloc infos rapides -->
    <div class="card grid grid-2">
      <div>
        <label>Points de Vie</label>
        <input id="pv" type="number" value="10" oninput="saveData()">
      </div>
      <div>
        <label>Classe d'Armure</label>
        <input id="ca" type="number" value="12" oninput="saveData()">
      </div>
      <div>
        <label>Initiative</label>
        <input id="initiative" type="number" value="2" oninput="saveData()">
      </div>
      <div>
        <label>Vitesse (m)</label>
        <input id="vitesse" type="number" value="9" oninput="saveData()">
      </div>
    </div>

    <!-- Caractéristiques -->
    <div class="card">
      <h2>Caractéristiques</h2>
      <div class="grid grid-3" id="stats"></div>
    </div>

    <!-- Attaques -->
    <div class="card">
      <h2>Attaques</h2>
      <div id="attaques"></div>
      <button onclick="ajouterAttaque()">+ Ajouter Attaque</button>
    </div>

    <!-- Capacités -->
    <div class="card">
      <h2>Capacités</h2>
      <div id="capacites"></div>
      <button onclick="ajouterCapacite()">+ Ajouter Capacité</button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'ficheDnD_v1';

    function storageAvailable() {
      try {
        const x = '__test__';
        localStorage.setItem(x, x);
        localStorage.removeItem(x);
        return true;
      } catch (e) {
        return false;
      }
    }

    function setStatus(msg) {
      const el = document.getElementById('status');
      if (el) el.textContent = msg;
    }

    function getDefaultData() {
      return {
        pv: "10",
        ca: "12",
        initiative: "2",
        vitesse: "9",
        stats: ["10","10","10","10","10","10"],
        attaques: [{ nom: "Dague", bonus: "+5", degats: "1d4+3" }],
        capacites: ["Attaque sournoise", "Assassinat"]
      };
    }

    function saveData() {
      if (!storageAvailable()) {
        setStatus("⚠️ Sauvegarde locale indisponible (cookies / stockage bloqués).");
        return;
      }
      const data = {
        pv: document.getElementById('pv').value,
        ca: document.getElementById('ca').value,
        initiative: document.getElementById('initiative').value,
        vitesse: document.getElementById('vitesse').value,
        stats: Array.from(document.querySelectorAll('#stats input')).map(i => i.value),
        attaques: Array.from(document.querySelectorAll('#attaques .atk')).map(div => ({
          nom: div.querySelector('.nom').value,
          bonus: div.querySelector('.bonus').value,
          degats: div.querySelector('.degats').value
        })),
        capacites: Array.from(document.querySelectorAll('#capacites input')).map(i => i.value)
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      setStatus("Sauvegardé ✅");
      clearTimeout(window._statusTimeout);
      window._statusTimeout = setTimeout(() => setStatus("Sauvegarde automatique activée ✅"), 1500);
    }

    function loadData() {
      let data = null;
      try {
        data = JSON.parse(localStorage.getItem(STORAGE_KEY));
      } catch (e) {
        data = null;
      }
      if (!data) data = getDefaultData();

      document.getElementById('pv').value = data.pv ?? "10";
      document.getElementById('ca').value = data.ca ?? "12";
      document.getElementById('initiative').value = data.initiative ?? "2";
      document.getElementById('vitesse').value = data.vitesse ?? "9";

      const statsNames = ["FOR","DEX","CON","INT","SAG","CHA"];
      const statsDiv = document.getElementById('stats');
      statsDiv.innerHTML = '';
      statsNames.forEach((s, i) => {
        const input = document.createElement('input');
        input.value = (data.stats && data.stats[i]) ? data.stats[i] : "10";
        input.oninput = saveData;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<label>${s}</label>`;
        wrapper.appendChild(input);
        statsDiv.appendChild(wrapper);
      });

      const attaquesDiv = document.getElementById('attaques');
      attaquesDiv.innerHTML = '';
      (data.attaques || []).forEach(a => ajouterAttaque(a.nom, a.bonus, a.degats));

      const capsDiv = document.getElementById('capacites');
      capsDiv.innerHTML = '';
      (data.capacites || []).forEach(c => ajouterCapacite(c, false));

      saveData();
    }

    function ajouterAttaque(nom='', bonus='', degats='') {
      const container = document.createElement('div');
      container.className = 'atk grid grid-3';
      container.innerHTML = `
        <input class="nom" placeholder="Nom" value="${nom}" oninput="saveData()">
        <input class="bonus" placeholder="Bonus" value="${bonus}" oninput="saveData()">
        <input class="degats" placeholder="Dégâts" value="${degats}" oninput="saveData()">
      `;
      document.getElementById('attaques').appendChild(container);
      saveData();
    }

    function ajouterCapacite(val='', doSave=true) {
      const input = document.createElement('input');
      input.value = val;
      input.placeholder = "Nouvelle capacité";
      input.oninput = saveData;
      document.getElementById('capacites').appendChild(input);
      if (doSave) saveData();
    }

    function exportData() {
      const dataStr = localStorage.getItem(STORAGE_KEY) || JSON.stringify(getDefaultData());
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fiche-dnd.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parsed = JSON.parse(e.target.result);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
          loadData();
          setStatus("Import réussi ✅");
        } catch (err) {
          setStatus("❌ Fichier invalide (JSON attendu).");
        }
      };
      reader.readAsText(file);
    }

    function resetAll() {
      if (confirm("Réinitialiser la fiche ?")) {
        localStorage.removeItem(STORAGE_KEY);
        loadData();
      }
    }

    window.addEventListener('load', () => {
      if (!storageAvailable()) {
        setStatus("⚠️ Sauvegarde locale indisponible (cookies / stockage bloqués). Les changements ne persisteront pas.");
      }
      loadData();

      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importInput').click());
      document.getElementById('importInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) importData(file);
      });
      document.getElementById('resetBtn').addEventListener('click', resetAll);
    });
  </script>
</body>
</html>
