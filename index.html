<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fiche D&D 2024 ‚Äî v25 (toggle global Caract√©ristiques)</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
<style>
:root{
  --violet:#281a3f; --black:#0b0a0d; --white:#f3efe7;
  --gold:#c9a84a; --gold2:#f1d76b; --muted:#c9c5bb; --gap:16px;
}
*{box-sizing:border-box;min-width:0}
html,body{height:100%}
body{
  margin:0;color:var(--white);font-family:"EB Garamond",serif;
  background:
    radial-gradient(80vw 60vh at 20% 0%, rgba(241,215,107,.06), transparent 70%),
    radial-gradient(60vw 60vh at 80% 20%, rgba(201,168,74,.06), transparent 70%),
    linear-gradient(180deg,#0a090c,var(--violet) 45%,#0a090c 100%);
  background-attachment:fixed;
}
.wrapper{max-width:1180px;margin:28px auto;padding:0 14px}
.sheet{position:relative;background:linear-gradient(180deg,rgba(11,10,13,.7),rgba(11,10,13,.55));
  border:3px solid #000;border-radius:28px;padding:22px;box-shadow:0 0 50px rgba(0,0,0,.75),inset 0 0 30px rgba(0,0,0,.7)}
h1{font-family:"IM Fell English",serif;font-size:32px;text-align:center;margin:0 0 10px;color:var(--white);text-shadow:0 0 10px rgba(0,0,0,.8)}
h1:after{content:"";display:block;height:3px;margin:10px auto 0;width:260px;
  background:linear-gradient(90deg,transparent,var(--gold),var(--gold2),var(--gold),transparent);border-radius:3px;box-shadow:0 0 12px rgba(241,215,107,.35)}
.subtitle{color:var(--muted);text-align:center;margin-bottom:16px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0 16px}
.btn{border:1px solid #000;border-radius:12px;padding:9px 14px;background:linear-gradient(180deg,#22192f,#120c1b);color:var(--white);font-weight:700;cursor:pointer}
.btn.sec{background:linear-gradient(180deg,#1b1a1e,#0f0e11)}
.btn.dan{background:linear-gradient(180deg,#3a1313,#1c0b0b)}
.btn.sm{padding:6px 10px;font-size:14px}
.hr{height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:10px 0;border-radius:1px}
/* Grid */
.board{display:grid;grid-template-columns:repeat(3,minmax(280px,1fr));gap:var(--gap);align-items:start}
.left-area{grid-column:1/span 2}
.right-col{grid-column:3;display:flex;flex-direction:column;gap:var(--gap)}
@media (max-width:1100px){.board{grid-template-columns:repeat(2,minmax(260px,1fr))}.left-area,.right-col{grid-column:1/span 2}}
@media (max-width:720px){.board{grid-template-columns:1fr}.left-area,.right-col{grid-column:1}.btn{width:100%}}
/* Card + gold ornaments */
.card{position:relative;background:
  radial-gradient(120% 120% at 50% -20%, rgba(241,215,107,.07), transparent 60%),
  linear-gradient(180deg,rgba(40,26,63,.88),rgba(17,12,26,.88));
  border:3px solid #000;border-radius:22px;padding:14px;box-shadow:inset 0 0 22px rgba(0,0,0,.8),0 10px 26px rgba(0,0,0,.75);overflow:hidden}
.card:before{content:"";position:absolute;inset:8px;border-radius:16px;border:2px solid rgba(201,168,74,.65);box-shadow:inset 0 0 10px rgba(241,215,107,.15);pointer-events:none}
.card:after{content:"";position:absolute;inset:0;border-radius:22px;background:
  radial-gradient(30px 30px at 0 0, rgba(201,168,74,.5), transparent 60%),
  radial-gradient(30px 30px at 100% 0, rgba(201,168,74,.5), transparent 60%),
  radial-gradient(30px 30px at 0 100%, rgba(201,168,74,.5), transparent 60%),
  radial-gradient(30px 30px at 100% 100%, rgba(201,168,74,.5), transparent 60%),
  radial-gradient(50% 50% at 50% 0%, rgba(0,0,0,.25), transparent 70%);
  mix-blend-mode:overlay;pointer-events:none}
.title{font-family:"IM Fell English",serif;font-size:16px;text-align:center;margin:0 0 10px;letter-spacing:.5px;text-shadow:0 0 6px rgba(0,0,0,.6);position:relative;padding-right:28px}
.title span{padding:0 10px;background:linear-gradient(180deg,rgba(201,168,74,.22),rgba(201,168,74,.06));border:1px solid rgba(201,168,74,.35);border-radius:8px;box-shadow:inset 0 0 6px rgba(241,215,107,.15)}
.title:before,.title:after{content:"‚óÜ";color:var(--gold2);margin:0 8px;text-shadow:0 0 8px rgba(241,215,107,.4)}
.handle{position:absolute;top:0;right:6px;height:32px;width:22px;display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:grab}
.handle:after{content:"‚ãÆ‚ãÆ";letter-spacing:2px}
label{font-size:13px;color:var(--muted)}
.inp,.ta{width:100%;border:1px solid #000;border-radius:12px;padding:9px 10px;font-size:16px;background:linear-gradient(180deg,#160f22,#0e0a14);color:var(--white);box-shadow:inset 0 1px 0 rgba(255,255,255,.06)}
.ta{min-height:90px;resize:vertical}
.row{display:grid;gap:12px}
.row2{grid-template-columns:1fr 1fr}
.row3{grid-template-columns:1fr 1fr 1fr}
/* Caract√©ristiques en 2 colonnes */
.abilities-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.abilities-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width:720px){.abilities-grid{grid-template-columns:1fr}}
.abilities-compact .sub{display:none} /* Vue compacte globale */
.ability{border:2px solid #000;border-radius:16px;padding:10px;background:linear-gradient(180deg,rgba(40,26,63,.85),rgba(17,12,26,.85));box-shadow:inset 0 0 16px rgba(0,0,0,.8)}
.ability-h{display:grid;grid-template-columns:1fr 80px;gap:10px;align-items:end}
.badge{border:1px solid #000;border-radius:12px;padding:8px;text-align:center;font-weight:700;color:var(--white);background:linear-gradient(180deg,rgba(201,168,74,.22),rgba(201,168,74,.06));box-shadow:inset 0 0 8px rgba(241,215,107,.2)}
.sub{margin-top:8px;border-top:1px solid rgba(201,168,74,.35);padding-top:8px}
.subrow{display:grid;grid-template-columns:28px 1fr 110px;gap:8px;align-items:center;margin:3px 0}
.dagger{text-align:center;font-size:18px;opacity:.95}
/* stars */
.stars{display:flex;gap:6px;flex-wrap:wrap;padding:4px 0 2px}
.star{width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:20px;border:1px solid #000;border-radius:10px;background:linear-gradient(180deg,#1f162b,#0f0e11);color:var(--white);cursor:pointer;user-select:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.06);flex:0 0 auto}
.star.active.gold{background:linear-gradient(180deg,var(--gold2),var(--gold));color:#1a1406;border-color:#1a1406}
.star.active.black{background:linear-gradient(180deg,#2a2a2a,#111);color:#fff;border-color:#000}
/* list rows */
.list{display:grid;grid-template-columns:1fr 42px;gap:10px;align-items:center;margin-bottom:8px}
.icon{background:linear-gradient(180deg,#1b1a1e,#0f0e11);color:var(--white);border:1px solid #000;border-radius:10px;padding:8px 10px;cursor:pointer}
.icon.del{background:linear-gradient(180deg,#3a1313,#1c0b0b)}
.atk{display:grid;grid-template-columns:1.1fr 80px 1fr 42px;gap:10px;align-items:start;margin-bottom:10px}
@media (max-width:720px){.atk{grid-template-columns:1fr}}
.atk-desc{grid-column:1/-2}
</style>
</head>
<body>
<div class="wrapper">
  <div class="sheet">
    <h1>Fiche de Personnage ‚Äî D&D 2024</h1>
    <div class="subtitle" id="status">v25 ‚Ä¢ Toggle global Caract√©ristiques ‚Ä¢ 2 colonnes ‚Ä¢ Mods temps r√©el</div>

    <div class="toolbar">
      <button class="btn" id="exportBtn">üì§ Exporter</button>
      <label>
        <input type="file" id="importInput" accept="application/json" hidden>
        <button class="btn sec" id="importBtn">üì• Importer</button>
      </label>
      <button class="btn dan" id="resetBtn">üßπ R√©initialiser</button>
    </div>

    <div class="board">
      <div class="left-area">
        <div class="card" id="abilitiesCard">
          <div class="title"><span>Caract√©ristiques</span></div>

          <div class="abilities-header">
            <div style="color:var(--muted);font-size:13px">Les modificateurs se calculent automatiquement.</div>
            <button class="btn sm sec" id="toggleCompactBtn">Vue compacte</button>
          </div>

          <div id="abilities" class="abilities-grid"></div>

        </div>
      </div>

      <div class="right-col" id="rightCol"><!-- rempli par JS --></div>
    </div>
  </div>
</div>

<script>
/* ====== Constantes & utilitaires ====== */
const K='sheet2024_v25', ORDER='sheet2024_v25_right_order';
const ABILITIES=[{key:'FOR',name:'Force'},{key:'DEX',name:'Dext√©rit√©'},{key:'CON',name:'Constitution'},{key:'INT',name:'Intelligence'},{key:'SAG',name:'Sagesse'},{key:'CHA',name:'Charisme'}];
const SKILLS={FOR:['Athl√©tisme'],DEX:['Acrobaties','Discr√©tion','Escamotage'],CON:[],INT:['Arcanes','Histoire','Investigation','Nature','Religion'],SAG:['Dressage','M√©decine','Perception','Intuition','Survie'],CHA:['Intimidation','Persuasion','Repr√©sentation','Tromperie']};
const qs=(s,p=document)=>p.querySelector(s); const qsa=(s,p=document)=>[...p.querySelectorAll(s)];
const v=(id)=>qs('#'+id)?.value??''; const setV=(id,val)=>{const el=qs('#'+id); if(el) el.value=val};
const setT=(id,t)=>{const el=qs('#'+id); if(el) el.textContent=t};
const i=(x,d=0)=>{const n=parseInt(x,10); return isNaN(n)?d:n};
const mod=(n)=>Math.floor((i(n,10)-10)/2); const fmt=(n)=> (n>=0?'+':'')+n;
const canStore=()=>{try{localStorage.setItem('__t','1');localStorage.removeItem('__t');return true}catch(_){return false}};

  /* ====== Cloud sync (Vercel + Upstash) ====== */
const CLOUD_ID = new URLSearchParams(location.search).get('id') || 'default';

async function cloudGet() {
  const url = `/api/sheet/${encodeURIComponent(CLOUD_ID)}`;
  // IMPORTANT : pas de cache navigateur (tablette/PC)
  const r = await fetch(url, { cache: 'no-store' });
  const j = await r.json();
  return j?.data?.payload || null;
}

async function cloudPut(payload) {
  const url = `/api/sheet/${encodeURIComponent(CLOUD_ID)}`;
  await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ payload, updatedAt: Date.now() })
  });
}

/* ====== √âtat par d√©faut ====== */
function defaults(){
  const o={char_name:'',class_only:'',level:1,background:'',race:'',subclass:'',prof_bonus:2,
    inspirationStars:0,ds_success:0,ds_failure:0,
    abilities:{FOR:10,DEX:10,CON:10,INT:10,SAG:10,CHA:10},
    saveManual:{FOR:'',DEX:'',CON:'',INT:'',SAG:'',CHA:''},
    skillManual:{},
    abilitiesCompact:false, /* << √©tat global compact/√©tendu */
    ac:12,init:2,speed:9,hp:10,hp_max:10,hit_dice:'1d8',temp_notes:'',
    attacks:[{name:'Dague',bonus:'+5',dmg:'1d4+3',desc:''}],
    inventory:['Rations (1 jour)','Corde (15 m)'],
    features:['Attaque sournoise','Assassinat']
  };
  Object.values(SKILLS).flat().forEach(n=>o.skillManual[n]='');
  return o;
}

/* ====== Persistance ====== */
function isCompact(){ return qs('#abilities').classList.contains('abilities-compact'); }
function collect(){
  const d=defaults();
  ABILITIES.forEach(a=>{
    d.abilities[a.key]=i(v('abl_'+a.key),10);
    d.saveManual[a.key]=v('sav_'+a.key);
  });
  Object.values(SKILLS).flat().forEach(n=>d.skillManual[n]=v('sk_'+n));
  d.char_name=v('char_name'); d.class_only=v('class_only'); d.level=i(v('level'),1);
  d.background=v('background'); d.race=v('race'); d.subclass=v('subclass'); d.prof_bonus=i(v('prof_bonus'),2);
  d.ac=i(v('ac'),12); d.init=i(v('init'),2); d.speed=i(v('speed'),9);
  d.hp=i(v('hp'),10); d.hp_max=i(v('hp_max'),10); d.hit_dice=v('hit_dice'); d.temp_notes=v('temp_notes');
  d.inspirationStars=starsCount(['star1','star2','star3']);
  d.ds_success=starsCount(['ds_s1','ds_s2','ds_s3']); d.ds_failure=starsCount(['ds_f1','ds_f2','ds_f3']);
  d.attacks=qsa('[data-attack]').map(r=>({name:qs('.atk-name',r).value,bonus:qs('.atk-bonus',r).value,dmg:qs('.atk-dmg',r).value,desc:qs('.atk-desc',r).value}));
  d.inventory=qsa('[data-item]').map(x=>x.value);
  d.features=qsa('[data-feature]').map(x=>x.value);
  d.abilitiesCompact=isCompact();
  return d;
}
function save(){
  if(!canStore()) { setStatus('‚ö†Ô∏è Sauvegarde inactive'); return; }

  // local d‚Äôabord
  const payload = collect();
  localStorage.setItem(K, JSON.stringify(payload));
  setStatus('Sauvegard√© ‚úÖ');

  // cloud (debounce)
  clearTimeout(window._cloudDeb);
  window._cloudDeb = setTimeout(async () => {
    try {
      await cloudPut(payload);
      setStatus('Sauvegard√© + Cloud ‚òÅÔ∏è');
      clearTimeout(window._st);
      window._st = setTimeout(()=>setStatus('v25 pr√™te ‚úÖ'), 1200);
    } catch(e){
      setStatus('‚ö†Ô∏è Cloud indisponible');
      console.error(e);
    }
  }, 400);
}

function setStatus(s){ setT('status',s); }
async function load(){
  let d = null;

  // 1) Essaye le cloud (no-store c√¥t√© fetch dans cloudGet)
  try {
    const cloud = await cloudGet();
    if (cloud) {
      d = cloud;
      setStatus(`Donn√©es cloud charg√©es ‚òÅÔ∏è (id=${CLOUD_ID})`);
    }
  } catch(_) {}

  // 2) Sinon fallback sur local
  if(!d) {
    try { d = JSON.parse(localStorage.getItem(K)); } catch(_) {}
  }
  if(!d) d = defaults();

  renderAbilities(d); renderRight(d); applyRightOrder(); initDnD();
  ABILITIES.forEach(a=>setT('mod_'+a.key,fmt(mod(d.abilities[a.key]))));
  syncStars(['star1','star2','star3'], d.inspirationStars,'gold');
  syncStars(['ds_s1','ds_s2','ds_s3'], d.ds_success,'gold');
  syncStars(['ds_f1','ds_f2','ds_f3'], d.ds_failure,'black');

  // appliquer l‚Äô√©tat compact global
  const wrap=qs('#abilities');
  wrap.classList.toggle('abilities-compact', !!d.abilitiesCompact);
  setToggleLabel();

  localStorage.setItem(K,JSON.stringify(d));
}

/* ====== Toggle global compact ====== */
function setToggleLabel(){
  const btn=qs('#toggleCompactBtn');
  const compact=isCompact();
  btn.textContent = compact ? 'Vue d√©taill√©e' : 'Vue compacte';
}
function toggleCompact(){
  const wrap=qs('#abilities');
  wrap.classList.toggle('abilities-compact');
  setToggleLabel();
  save(); // m√©morise l‚Äô√©tat
}

/* ====== Caract√©ristiques (gauche) ====== */
const dagger=()=>'<div class="dagger"><span>üó°Ô∏è</span></div>';
function renderAbilities(d){
  const host=qs('#abilities'); host.innerHTML='';
  ABILITIES.forEach(a=>{
    const list=SKILLS[a.key]||[];
    const skillRows=list.map(s=>`
      <div class="subrow">${dagger()}<div>${s}</div>
        <input class="inp" type="number" id="sk_${s}" placeholder="bonus" value="${d.skillManual[s]??''}" oninput="save()">
      </div>`).join('');
    const html=`
      <div class="ability" data-key="${a.key}">
        <div class="ability-h">
          <div>
            <label>${a.name}</label>
            <input class="inp" id="abl_${a.key}" type="number" value="${d.abilities[a.key]??10}" oninput="recalcMods();save()">
          </div>
          <div class="badge" id="mod_${a.key}">${fmt(mod(d.abilities[a.key]))}</div>
        </div>
        <div class="sub">
          <div class="subrow">${dagger()}<div>Sauvegarde</div>
            <input class="inp" type="number" id="sav_${a.key}" placeholder="bonus" value="${d.saveManual[a.key]??''}" oninput="save()">
          </div>
          ${skillRows}
        </div>
      </div>`;
    host.insertAdjacentHTML('beforeend',html);
  });
}
function recalcMods(){ ABILITIES.forEach(a=>setT('mod_'+a.key,fmt(mod(v('abl_'+a.key))))); }

/* ====== Colonne droite ====== */
function rightCard(id,title,inner){ return `
  <div class="card" data-cardid="${id}">
    <div class="title"><span>${title}</span><div class="handle" title="D√©placer"></div></div>
    ${inner}
  </div>`; }
function renderRight(d){
  const col=qs('#rightCol'); col.innerHTML='';
  col.insertAdjacentHTML('beforeend', rightCard('identity', 'Identit√©', `
    <label>Nom du personnage</label><input id="char_name" class="inp" type="text" value="${d.char_name}" oninput="save()">
    <div class="row row2">
      <div><label>Classe</label><input id="class_only" class="inp" type="text" value="${d.class_only}" oninput="save()"></div>
      <div><label>Niveau</label><input id="level" class="inp" type="number" min="1" value="${d.level}" oninput="save()"></div>
    </div>
    <div class="row row2">
      <div><label>Origine/Background</label><input id="background" class="inp" type="text" value="${d.background}" oninput="save()"></div>
      <div><label>Race</label><input id="race" class="inp" type="text" value="${d.race}" oninput="save()"></div>
    </div>
    <div class="row row2">
      <div><label>Sous-classe</label><input id="subclass" class="inp" type="text" value="${d.subclass}" oninput="save()"></div>
      <div><label>Bonus de ma√Ætrise</label><input id="prof_bonus" class="inp" type="number" step="1" value="${d.prof_bonus}" oninput="save()"></div>
    </div>
    <div class="hr"></div>
    <label>Inspiration h√©ro√Øque</label>
    <div class="stars">
      <div class="star" id="star1" onclick="toggleStars(['star1','star2','star3'],1,'gold')">‚òÖ</div>
      <div class="star" id="star2" onclick="toggleStars(['star1','star2','star3'],2,'gold')">‚òÖ</div>
      <div class="star" id="star3" onclick="toggleStars(['star1','star2','star3'],3,'gold')">‚òÖ</div>
    </div>
  `));
  col.insertAdjacentHTML('beforeend', rightCard('combat', 'Combat', `
    <div class="row row3">
      <div><label>Classe d'armure</label><input id="ac" class="inp" type="number" value="${d.ac}" oninput="save()"></div>
      <div><label>Initiative</label><input id="init" class="inp" type="number" value="${d.init}" oninput="save()"></div>
      <div><label>Vitesse (m)</label><input id="speed" class="inp" type="number" value="${d.speed}" oninput="save()"></div>
    </div>
    <div class="row row2">
      <div><label>Points de vie (actuels / max)</label>
        <div class="row" style="grid-template-columns:1fr auto 1fr">
          <input id="hp" class="inp" type="number" value="${d.hp}" oninput="save()"><span style="place-self:center">/</span>
          <input id="hp_max" class="inp" type="number" value="${d.hp_max}" oninput="save()">
        </div>
      </div>
      <div><label>D√©s de vie (ex. 3d8)</label><input id="hit_dice" class="inp" type="text" value="${d.hit_dice}" oninput="save()"></div>
    </div>
    <div class="row row2">
      <div><label>√âtat temporaire / Notes</label><input id="temp_notes" class="inp" type="text" value="${d.temp_notes}" oninput="save()"></div>
      <div>
        <label>Jets contre la mort</label>
        <div style="color:var(--muted);font-size:13px">Succ√®s</div>
        <div class="stars">
          <div class="star" id="ds_s1" onclick="toggleStars(['ds_s1','ds_s2','ds_s3'],1,'gold')">‚òÖ</div>
          <div class="star" id="ds_s2" onclick="toggleStars(['ds_s1','ds_s2','ds_s3'],2,'gold')">‚òÖ</div>
          <div class="star" id="ds_s3" onclick="toggleStars(['ds_s1','ds_s2','ds_s3'],3,'gold')">‚òÖ</div>
        </div>
        <div style="color:var(--muted);font-size:13px">√âchecs</div>
        <div class="stars">
          <div class="star" id="ds_f1" onclick="toggleStars(['ds_f1','ds_f2','ds_f3'],1,'black')">‚òÖ</div>
          <div class="star" id="ds_f2" onclick="toggleStars(['ds_f1','ds_f2','ds_f3'],2,'black')">‚òÖ</div>
          <div class="star" id="ds_f3" onclick="toggleStars(['ds_f1','ds_f2','ds_f3'],3,'black')">‚òÖ</div>
        </div>
      </div>
    </div>
  `));
  const atkRows = (d.attacks||[]).map(a=>attackRow(a.name,a.bonus,a.dmg,a.desc)).join('');
  col.insertAdjacentHTML('beforeend', rightCard('attacks','Attaques & sorts',`
    <div id="attacks">${atkRows}</div>
    <button class="btn sec" onclick="addAttack()">+ Ajouter</button>
  `));
  const inv = (d.inventory||[]).map(v=>listRow('item',v)).join('');
  col.insertAdjacentHTML('beforeend', rightCard('inventory','√âquipement & tr√©sors',`
    <div id="inventory">${inv}</div>
    <button class="btn sec" onclick="addItem()">+ Ajouter objet</button>
  `));
  const feats = (d.features||[]).map(v=>listRow('feature',v,'Nouveau trait / don / capacit√©')).join('');
  col.insertAdjacentHTML('beforeend', rightCard('features','Traits, dons & capacit√©s',`
    <div id="features">${feats}</div>
    <button class="btn sec" onclick="addFeature()">+ Ajouter capacit√©</button>
  `));
}
/* templates */
function attackRow(name='',bonus='',dmg='',desc=''){ return `
  <div class="atk" data-attack>
    <input class="inp atk-name" type="text" placeholder="Nom (ex. Dague)" value="${name}" oninput="save()">
    <input class="inp atk-bonus" type="text" placeholder="+X" value="${bonus}" oninput="save()">
    <input class="inp atk-dmg" type="text" placeholder="XdY+Z" value="${dmg}" oninput="save()">
    <button class="icon del" title="Supprimer" onclick="this.closest('[data-attack]').remove();save()">‚úï</button>
    <textarea class="ta atk-desc" placeholder="Description / effets / conditions" oninput="save()">${desc||''}</textarea>
  </div>`;}
function listRow(kind,val,ph='Nouvel objet'){ return `
  <div class="list">
    <input class="inp" type="text" data-${kind} value="${val}" placeholder="${ph}" oninput="save()">
    <button class="icon del" title="Supprimer" onclick="this.parentElement.remove();save()">‚úï</button>
  </div>`;}
/* add items */
function addAttack(){ qs('#attacks').insertAdjacentHTML('beforeend', attackRow()); save(); }
function addItem(){ qs('#inventory').insertAdjacentHTML('beforeend', listRow('item','')); save(); }
function addFeature(){ qs('#features').insertAdjacentHTML('beforeend', listRow('feature','','Nouveau trait / don / capacit√©')); save(); }

/* ====== √âtoiles ====== */
function starsCount(ids){return ids.reduce((c,id)=>c+(qs('#'+id)?.classList.contains('active')?1:0),0)}
function syncStars(ids,n,cls){ ids.forEach((id,idx)=>{const el=qs('#'+id); if(!el)return; el.classList.remove('active','gold','black'); if(idx<n){el.classList.add('active',cls)}}); }
function toggleStars(ids,n,cls){ const cur=starsCount(ids.map(id=>id)); const next=(n<=cur)?n-1:n; syncStars(ids,next,cls); save(); }

/* ====== Drag & drop colonne droite ====== */
function initDnD(){
  const col=qs('#rightCol');
  col.addEventListener('dragover',e=>{e.preventDefault();const drag=qs('#rightCol .card.dragging'); if(!drag)return; const after=getAfter(col,e.clientY); after?col.insertBefore(drag,after):col.appendChild(drag);});
  col.addEventListener('drop',saveRightOrder);
  qsa('#rightCol .card').forEach(card=>{
    const h=qs('.handle',card); if(!h)return;
    qsa('input,textarea,button',card).forEach(el=>el.setAttribute('draggable','false'));
    h.addEventListener('mousedown',()=>card.setAttribute('draggable','true'));
    h.addEventListener('touchstart',()=>card.setAttribute('draggable','true'),{passive:true});
    card.addEventListener('dragstart',()=>card.classList.add('dragging'));
    card.addEventListener('dragend',()=>{card.classList.remove('dragging');card.setAttribute('draggable','false');saveRightOrder();});
  });
  function getAfter(container,y){
    return qsa('.card:not(.dragging)',container).reduce((c,ch)=>{
      const box=ch.getBoundingClientRect(); const off=y-box.top-box.height/2;
      return (off<0 && off>c.off)?{off:off,el:ch}:c;
    },{off:Number.NEGATIVE_INFINITY,el:null}).el;
  }
}
function saveRightOrder(){ const order=qsa('#rightCol>.card').map(c=>c.dataset.cardid); localStorage.setItem(ORDER,JSON.stringify(order)); }
function applyRightOrder(){
  let order=null; try{order=JSON.parse(localStorage.getItem(ORDER))}catch(_){}
  if(!order) return; const col=qs('#rightCol'); const map={}; qsa('#rightCol>.card').forEach(c=>map[c.dataset.cardid]=c);
  order.forEach(id=>{ if(map[id]) col.appendChild(map[id]); });
}

/* ====== Export / Import / Reset ====== */
function exportJSON(){
  const blob=new Blob([JSON.stringify(collect())],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download='fiche-dnd-2024.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
}
function importJSON(file){
  const r=new FileReader(); r.onload=e=>{try{const data=JSON.parse(e.target.result);localStorage.setItem(K,JSON.stringify(data));load();setStatus('Import r√©ussi ‚úÖ')}catch{setStatus('‚ùå Fichier invalide')}}; r.readAsText(file);
}
function resetAll(){ if(confirm('R√©initialiser la fiche ?')){localStorage.removeItem(K);load();} }

/* ====== Boot ====== */
window.addEventListener('load',()=>{
  load();
  qs('#exportBtn').addEventListener('click',exportJSON);
  qs('#importBtn').addEventListener('click',()=>qs('#importInput').click());
  qs('#importInput').addEventListener('change',e=>{const f=e.target.files[0]; if(f) importJSON(f);});
  qs('#resetBtn').addEventListener('click',resetAll);
  qs('#toggleCompactBtn').addEventListener('click',toggleCompact);
});
/* expose global */
window.recalcMods=recalcMods; window.addAttack=addAttack; window.addItem=addItem; window.addFeature=addFeature;
window.toggleStars=toggleStars; window.save=save; window.toggleCompact=toggleCompact;
</script>
</body>
</html>
