<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fiche D&D 2024 — v21 (or décoratif + mods temps réel)</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root{
    --violet:#281a3f;
    --black:#0b0a0d;
    --white:#f3efe7;
    --gold:#c9a84a;
    --gold2:#f1d76b;
    --muted:#c9c5bb;
    --gap:16px;
  }
  html,body{height:100%}
  *{box-sizing:border-box; min-width:0;}
  body{
    margin:0; color:var(--white); font-family:"EB Garamond", serif;
    background:
      radial-gradient(80vw 60vh at 20% 0%, rgba(241,215,107,0.06), transparent 70%),
      radial-gradient(60vw 60vh at 80% 20%, rgba(201,168,74,0.06), transparent 70%),
      linear-gradient(180deg, #0a090c, var(--violet) 45%, #0a090c 100%);
    background-attachment: fixed;
  }
  .wrapper{max-width:1180px;margin:28px auto;padding:0 14px;}
  .sheet{
    position:relative;
    background:linear-gradient(180deg, rgba(11,10,13,.7), rgba(11,10,13,.55));
    border:3px solid #000; border-radius:28px; padding:22px;
    box-shadow:0 0 50px rgba(0,0,0,.75), inset 0 0 30px rgba(0,0,0,.7);
  }
  h1{
    font-family:"IM Fell English",serif; font-size:32px; text-align:center; margin:0 0 10px; color:var(--white);
    text-shadow:0 0 10px rgba(0,0,0,.8); position:relative;
  }
  h1:after{
    content:""; display:block; height:3px; margin:10px auto 0; width:260px;
    background:linear-gradient(90deg, transparent, var(--gold), var(--gold2), var(--gold), transparent);
    border-radius:3px; box-shadow:0 0 12px rgba(241,215,107,.35);
  }
  .subtitle{color:var(--muted);text-align:center;margin-bottom:16px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:8px 0 16px}
  button{
    border:1px solid #000;border-radius:12px;padding:9px 14px;background:linear-gradient(180deg,#22192f,#120c1b);color:var(--white);
    font-weight:700;cursor:pointer; font-family:"EB Garamond",serif; font-size:16px;
    box-shadow: 0 1px 0 rgba(255,255,255,.06), 0 3px 10px rgba(0,0,0,.5);
  }
  button.secondary{background:linear-gradient(180deg,#1b1a1e,#0f0e11); border-color:#000}
  button.danger{background:linear-gradient(180deg,#3a1313,#1c0b0b)}
  .hr{height:1px;background:linear-gradient(90deg, transparent, var(--gold), transparent);margin:10px 0; border-radius:1px}

  /* Layout: left fixed (span 2), right col reorderable */
  .board{
    display:grid; grid-template-columns: repeat(3, minmax(280px, 1fr));
    gap: var(--gap); align-items:start;
  }
  .left-area{ grid-column: 1 / span 2; }
  .right-col{ grid-column: 3; display:flex; flex-direction:column; gap:var(--gap); }
  @media (max-width: 1100px){
    .board{ grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    .left-area{ grid-column: 1 / span 2; }
    .right-col{ grid-column: 1 / span 2; }
  }
  @media (max-width: 720px){
    .board{ grid-template-columns: 1fr; }
    .left-area{ grid-column: 1; }
    .right-col{ grid-column: 1; }
    button{width:100%}
  }

  /* Cards + ORNEMENTS DORÉS */
  .card{
    position:relative; z-index:0;
    background:
      radial-gradient(120% 120% at 50% -20%, rgba(241,215,107,.07), transparent 60%),
      linear-gradient(180deg, rgba(40,26,63,.88), rgba(17,12,26,.88));
    border:3px solid #000; border-radius:22px; padding:14px; color:var(--white);
    box-shadow:inset 0 0 22px rgba(0,0,0,.8), 0 10px 26px rgba(0,0,0,.75);
    overflow:hidden; align-self:start;
  }
  .card::before{
    content:""; position:absolute; inset:8px; border-radius:16px;
    border:2px solid rgba(201,168,74,.65);
    box-shadow:inset 0 0 10px rgba(241,215,107,.15);
    pointer-events:none; z-index:-1;
  }
  .card::after{
    content:""; position:absolute; inset:0; border-radius:22px;
    background:
      radial-gradient(30px 30px at 0 0, rgba(201,168,74,.5), transparent 60%),
      radial-gradient(30px 30px at 100% 0, rgba(201,168,74,.5), transparent 60%),
      radial-gradient(30px 30px at 0 100%, rgba(201,168,74,.5), transparent 60%),
      radial-gradient(30px 30px at 100% 100%, rgba(201,168,74,.5), transparent 60%),
      radial-gradient(50% 50% at 50% 0%, rgba(0,0,0,.25), transparent 70%);
    mix-blend-mode:overlay; pointer-events:none; z-index:-1;
  }

  .section-title{
    font-family:"IM Fell English",serif; font-size:16px; color:var(--white);
    text-align:center; margin:0 0 10px; letter-spacing:.5px; text-shadow:0 0 6px rgba(0,0,0,.6);
    padding-right:28px; position:relative;
  }
  .section-title span{
    padding:0 10px;
    background:linear-gradient(180deg, rgba(201,168,74,.22), rgba(201,168,74,.06));
    border-radius:8px; border:1px solid rgba(201,168,74,.35);
    box-shadow:inset 0 0 6px rgba(241,215,107,.15);
  }
  .section-title:before, .section-title:after{
    content:"◆"; color:var(--gold2); margin:0 8px; text-shadow:0 0 8px rgba(241,215,107,.4);
  }
  .drag-handle{
    position:absolute; top:0; right:6px; height:32px; width:22px;
    cursor:grab; user-select:none; color:var(--muted); display:flex; align-items:center; justify-content:center;
  }
  .drag-handle::after{ content:"⋮⋮"; font-size:16px; letter-spacing:2px; }

  label{font-size:13px;color:var(--muted);letter-spacing:.02em}
  input[type=number], input[type=text], textarea{
    width:100%; border:1px solid #000; border-radius:12px; padding:9px 10px; font-size:16px;
    background:linear-gradient(180deg, #160f22, #0e0a14); outline:none; color:var(--white);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06); font-family:"EB Garamond",serif;
  }
  textarea{ min-height:90px; resize:vertical; }

  .ability-card{
    border:2px solid #000; border-radius:16px; padding:10px;
    background:linear-gradient(180deg, rgba(40,26,63,.85), rgba(17,12,26,.85));
    box-shadow:inset 0 0 16px rgba(0,0,0,.8); margin-bottom:8px;
  }
  .ability-header{ display:grid; grid-template-columns: 1fr 80px; gap:10px; align-items:end; }
  .badge{
    border:1px solid #000; border-radius:12px; padding:8px; text-align:center; font-weight:700; color:var(--white);
    background:linear-gradient(180deg, rgba(201,168,74,.22), rgba(201,168,74,.06));
    box-shadow: inset 0 0 8px rgba(241,215,107,.2);
  }
  .sublist{ margin-top:8px; border-top:1px solid rgba(201,168,74,.35); padding-top:8px; }
  /* lignes manuelles : dague | libellé | input */
  .subrow{ display:grid; grid-template-columns: 28px 1fr 110px; gap:8px; align-items:center; margin:3px 0; }
  .dagger{ text-align:center; font-size:18px; opacity:.95; }
  .dagger span{ filter: drop-shadow(0 1px 0 rgba(0,0,0,.4)); }

  /* Étoiles */
  .stars{ display:flex; gap:6px; flex-wrap:wrap; overflow:hidden; padding:4px 0 2px; }
  .star{
    width:34px; height:34px; display:flex; align-items:center; justify-content:center; font-size:20px;
    border:1px solid #000; border-radius:10px;
    background:linear-gradient(180deg,#1f162b,#0f0a14);
    color:var(--white); cursor:pointer; user-select:none;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    flex:0 0 auto;
  }
  .star.active.gold{ background:linear-gradient(180deg, var(--gold2), var(--gold)); color:#1a1406; border-color:#1a1406; }
  .star.active.black{ background:linear-gradient(180deg, #2a2a2a, #111); color:#fff; border-color:#000; }

  .icon-btn{ background:linear-gradient(180deg,#1b1a1e,#0f0e11); color:var(--white); border:1px solid #000; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:700; }
  .icon-btn.del{ background:linear-gradient(180deg,#3a1313,#1c0b0b); }
  .list-row{ display:grid; grid-template-columns: 1fr 42px; gap:10px; align-items:center; margin-bottom:8px; }
  .atk-row{ display:grid; grid-template-columns: 1.1fr 80px 1fr 42px; gap:10px; align-items:start; margin-bottom:10px; }
  @media (max-width:720px){ .atk-row{ grid-template-columns: 1fr; } }
  .atk-desc{ grid-column: 1 / -2; }
</style>
</head>
<body>
  <div class="wrapper">
    <div class="sheet">
      <h1>Fiche de Personnage — D&D 2024</h1>
      <div class="subtitle" id="status">Ornements dorés ✅ — Mods en temps réel ✅ — Sous-caractéristiques manuelles ✅</div>

      <div class="toolbar">
        <button id="exportBtn">📤 Exporter</button>
        <label>
          <input type="file" id="importInput" accept="application/json" style="display:none">
          <button id="importBtn" class="secondary">📥 Importer</button>
        </label>
        <button id="resetBtn" class="danger">🧹 Réinitialiser fiche</button>
      </div>

      <div class="board" id="board">
        <!-- GAUCHE : Caractéristiques fixes (2 colonnes) -->
        <div class="left-area">
          <div class="card" data-cardid="abilities" data-fixed="1">
            <div class="section-title"><span>Caractéristiques</span></div>
            <div id="abilitiesBlock" class="grid" style="grid-template-columns:1fr;"></div>
            <div style="color:var(--muted);font-size:13px;margin-top:6px">
              Astuce : tu saisis à la main les bonus de sauvegarde et compétences. Les modificateurs se calculent automatiquement.
            </div>
          </div>
        </div>

        <!-- DROITE : cartes réorganisables -->
        <div class="right-col" id="rightCol">
          <div class="card" data-cardid="identity">
            <div class="section-title"><span>Identité</span><div class="drag-handle" title="Déplacer"></div></div>
            <label>Nom du personnage</label>
            <input id="char_name" type="text" oninput="save()">
            <div class="subitem" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <label>Classe</label>
                <input id="class_only" type="text" placeholder="Roublard" oninput="save()">
              </div>
              <div>
                <label>Niveau</label>
                <input id="level" type="number" min="1" value="1" oninput="save()">
              </div>
            </div>
            <div class="subitem" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <label>Origine/Background</label>
                <input id="background" type="text" oninput="save()">
              </div>
              <div>
                <label>Race</label>
                <input id="race" type="text" placeholder="Shadar-kai" oninput="save()">
              </div>
            </div>
            <div class="subitem" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <label>Sous-classe</label>
                <input id="subclass" type="text" placeholder="Assassin" oninput="save()">
              </div>
              <div>
                <label>Bonus de maîtrise</label>
                <input id="prof_bonus" type="number" step="1" value="2" oninput="save();recalc()">
              </div>
            </div>
            <div class="hr"></div>
            <div>
              <label>Inspiration héroïque</label>
              <div class="stars">
                <div class="star" id="star1" onclick="toggleStar(1,'insp')">★</div>
                <div class="star" id="star2" onclick="toggleStar(2,'insp')">★</div>
                <div class="star" id="star3" onclick="toggleStar(3,'insp')">★</div>
              </div>
            </div>
          </div>

          <div class="card" data-cardid="combat">
            <div class="section-title"><span>Combat</span><div class="drag-handle" title="Déplacer"></div></div>
            <div class="atk-row" style="grid-template-columns: 1fr 1fr 1fr;">
              <div>
                <label>Classe d'armure</label>
                <input id="ac" type="number" value="12" oninput="save()">
              </div>
              <div>
                <label>Initiative</label>
                <input id="init" type="number" value="2" oninput="save()">
              </div>
              <div>
                <label>Vitesse (m)</label>
                <input id="speed" type="number" value="9" oninput="save()">
              </div>
            </div>
            <div class="atk-row" style="grid-template-columns: 1fr 1fr;">
              <div>
                <label>Points de Vie (actuels / max)</label>
                <div style="display:flex;gap:6px;align-items:center">
                  <input id="hp" type="number" value="10" oninput="save()"><span>/</span><input id="hp_max" type="number" value="10" oninput="save()">
                </div>
              </div>
              <div>
                <label>Dés de vie (ex. 3d8)</label>
                <input id="hit_dice" type="text" value="1d8" oninput="save()">
              </div>
            </div>
            <div class="atk-row" style="grid-template-columns: 1fr 1fr;">
              <div>
                <label>État temporaire / Notes</label>
                <input id="temp_notes" type="text" oninput="save()">
              </div>
              <div>
                <label>Jets contre la mort</label>
                <div>
                  <div style="color:var(--muted);font-size:13px">Succès</div>
                  <div class="stars" style="margin-bottom:6px">
                    <div class="star" id="ds_s1" onclick="toggleStar(1,'ds_success')">★</div>
                    <div class="star" id="ds_s2" onclick="toggleStar(2,'ds_success')">★</div>
                    <div class="star" id="ds_s3" onclick="toggleStar(3,'ds_success')">★</div>
                  </div>
                  <div style="color:var(--muted);font-size:13px">Échecs</div>
                  <div class="stars">
                    <div class="star" id="ds_f1" onclick="toggleStar(1,'ds_failure')">★</div>
                    <div class="star" id="ds_f2" onclick="toggleStar(2,'ds_failure')">★</div>
                    <div class="star" id="ds_f3" onclick="toggleStar(3,'ds_failure')">★</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" data-cardid="attacks">
            <div class="section-title"><span>Attaques & sorts</span><div class="drag-handle" title="Déplacer"></div></div>
            <div id="attacks"></div>
            <button class="secondary" onclick="addAttack()">+ Ajouter</button>
          </div>

          <div class="card" data-cardid="inventory">
            <div class="section-title"><span>Équipement & trésors</span><div class="drag-handle" title="Déplacer"></div></div>
            <div id="inventory"></div>
            <button class="secondary" onclick="addItem()">+ Ajouter objet</button>
          </div>

          <div class="card" data-cardid="features">
            <div class="section-title"><span>Traits, dons & capacités</span><div class="drag-handle" title="Déplacer"></div></div>
            <div id="features"></div>
            <button class="secondary" onclick="addFeature()">+ Ajouter capacité</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const K = 'sheet2024_v21_gold';
  const RIGHT_ORDER_K = 'sheet2024_v20_right_order';

  const ABILITIES = [
    { key:'FOR', name:'Force' },
    { key:'DEX', name:'Dextérité' },
    { key:'CON', name:'Constitution' },
    { key:'INT', name:'Intelligence' },
    { key:'SAG', name:'Sagesse' },
    { key:'CHA', name:'Charisme' }
  ];

  const SKILLS = {
    FOR: ['Athlétisme'],
    DEX: ['Acrobaties','Discrétion','Escamotage'],
    CON: [],
    INT: ['Arcanes','Histoire','Investigation','Nature','Religion'],
    SAG: ['Dressage','Médecine','Perception','Intuition','Survie'],
    CHA: ['Intimidation','Persuasion','Représentation','Tromperie']
  };

  function modFrom(score){ const n = parseInt(score||10,10); return Math.floor((n-10)/2); }
  function fmt(n){ return (n>=0?'+':'')+n; }
  function storageOK(){ try{ localStorage.setItem('__x','1'); localStorage.removeItem('__x'); return true; }catch(e){ return false; } }

  function defaultData(){
    const obj = {
      char_name:'', class_only:'', level:1, background:'', race:'', subclass:'',
      prof_bonus:2, inspirationStars:0,
      ds_success:0, ds_failure:0,
      abilities:{ FOR:10, DEX:10, CON:10, INT:10, SAG:10, CHA:10 },
      saveManual:{ FOR:'', DEX:'', CON:'', INT:'', SAG:'', CHA:'' },
      skillManual:{},
      ac:12, init:2, speed:9, hp:10, hp_max:10, hit_dice:'1d8',
      temp_notes:'',
      attacks:[{name:'Dague',bonus:'+5',dmg:'1d4+3',desc:''}],
      inventory:['Rations (1 jour)','Corde (15 m)'],
      features:['Attaque sournoise','Assassinat']
    };
    Object.values(SKILLS).flat().forEach(n=>{ obj.skillManual[n]=''; });
    return obj;
  }

  function setStatus(s){ const a=document.getElementById('status'); if(a) a.textContent=s; }

  function save(){
    if(!storageOK()) { setStatus('⚠️ Sauvegarde locale indisponible.'); return; }
    const data = collect();
    localStorage.setItem(K, JSON.stringify(data));
    setStatus('Sauvegardé ✅');
    clearTimeout(window._st); window._st=setTimeout(()=>setStatus('Ornements dorés / mods temps réel / sous-carac manuelles ✅'),1200);
  }

  function load(){
    let d=null; try{ d=JSON.parse(localStorage.getItem(K)); }catch(e){}
    if(!d){
      try{
        const old = JSON.parse(localStorage.getItem('sheet2024_v21'));
        if(old){
          d = { ...defaultData(), ...old };
        }
      }catch(e){}
    }
    if(!d) d=defaultData();

    renderAbilities(d);
    fillGlobals(d);
    recalc();
    syncStars(d.inspirationStars);
    syncDeathStars(d.ds_success, d.ds_failure);
    localStorage.setItem(K, JSON.stringify(d));
    applySavedRightOrder();
    initRightDnD();
  }

  function fillGlobals(d){
    setVal('char_name',d.char_name);
    setVal('class_only',d.class_only);
    setVal('level',d.level);
    setVal('background',d.background);
    setVal('race',d.race);
    setVal('subclass',d.subclass);
    setVal('prof_bonus',d.prof_bonus);
    setVal('ac',d.ac); setVal('init',d.init); setVal('speed',d.speed);
    setVal('hp',d.hp); setVal('hp_max',d.hp_max); setVal('hit_dice',d.hit_dice);
    setVal('temp_notes',d.temp_notes);

    const atk=document.getElementById('attacks'); atk.innerHTML='';
    (d.attacks||[]).forEach((a,i)=>addAttack(a.name,a.bonus,a.dmg,a.desc,false,i));

    const inv=document.getElementById('inventory'); inv.innerHTML='';
    (d.inventory||[]).forEach((x,i)=>addItem(x,false,i));

    const ft=document.getElementById('features'); ft.innerHTML='';
    (d.features||[]).forEach((x,i)=>addFeature(x,false,i));
  }

  function daggerHTML(){ return '<div class="dagger"><span>🗡️</span></div>'; }

  function renderAbilities(d){
    const host = document.getElementById('abilitiesBlock');
    host.innerHTML='';
    ABILITIES.forEach(a=>{
      const card = document.createElement('div');
      card.className='ability-card';
      const score = d.abilities[a.key] ?? 10;
      const theMod = modFrom(score);
      const sav = (d.saveManual && d.saveManual[a.key]) ?? '';
      const list = SKILLS[a.key] || [];

      let skillsHTML='';
      list.forEach(sname=>{
        const val = (d.skillManual && d.skillManual[sname]) ?? '';
        skillsHTML += `
          <div class="subrow">
            ${daggerHTML()}
            <div>${sname}</div>
            <input type="number" id="skman_${sname}" placeholder="bonus" value="${val}" oninput="save()">
          </div>`;
      });

      card.innerHTML = `
        <div class="ability-header">
          <div>
            <label>${a.name}</label>
            <input id="abl_${a.key}" type="number" value="${score}" oninput="recalc(); save()">
          </div>
          <div class="badge" id="mod_${a.key}">${fmt(theMod)}</div>
        </div>
        <div class="sublist">
          <div class="subrow">
            ${daggerHTML()}
            <div>Sauvegarde</div>
            <input type="number" id="savman_${a.key}" placeholder="bonus" value="${sav}" oninput="save()">
          </div>
          ${skillsHTML}
        </div>
      `;
      host.appendChild(card);
    });
  }

  function collect(){
    const d = defaultData();
    d.char_name = val('char_name');
    d.class_only = val('class_only');
    d.level = int('level',1);
    d.background = val('background');
    d.race = val('race');
    d.subclass = val('subclass');
    d.prof_bonus = parseInt(val('prof_bonus')||2,10);

    ABILITIES.forEach(a=>{
      d.abilities[a.key] = parseInt(val('abl_'+a.key)||10,10);
      d.saveManual[a.key] = val('savman_'+a.key);
    });
    Object.values(SKILLS).flat().forEach(n=>{
      d.skillManual[n] = val('skman_'+n);
    });

    d.ac=int('ac',12); d.init=int('init',2); d.speed=int('speed',9);
    d.hp=int('hp',10); d.hp_max=int('hp_max',10); d.hit_dice=val('hit_dice');
    d.temp_notes=val('temp_notes');

    d.attacks = Array.from(document.querySelectorAll('[data-attack]')).map(row=>({
      name: row.querySelector('.atk-name').value,
      bonus: row.querySelector('.atk-bonus').value,
      dmg: row.querySelector('.atk-dmg').value,
      desc: row.querySelector('.atk-desc').value
    }));
    d.inventory = Array.from(document.querySelectorAll('[data-item]')).map(i=>i.value);
    d.features  = Array.from(document.querySelectorAll('[data-feature]')).map(i=>i.value);

    d.inspirationStars = currentStars('insp');
    d.ds_success = currentStars('ds_success');
    d.ds_failure = currentStars('ds_failure');
    return d;
  }

  function recalc(){
    ABILITIES.forEach(a=>{
      const score = parseInt(val('abl_'+a.key)||10,10);
      const m = modFrom(score);
      setText('mod_'+a.key, fmt(m));
    });
  }

  /* Étoiles */
  function currentStars(group){
    let ids = [];
    if(group==='insp') ids=['star1','star2','star3'];
    if(group==='ds_success') ids=['ds_s1','ds_s2','ds_s3'];
    if(group==='ds_failure') ids=['ds_f1','ds_f2','ds_f3'];
    let c=0; ids.forEach(id=>{ if(document.getElementById(id).classList.contains('active')) c++; });
    return c;
  }
  function syncStars(n){
    const ids=['star1','star2','star3'];
    ids.forEach((id,idx)=>{
      const el=document.getElementById(id);
      el.classList.remove('active','gold','black');
      if(idx<n) el.classList.add('active','gold');
    });
  }
  function syncDeathStars(succ, fail){
    ['ds_s1','ds_s2','ds_s3'].forEach((id,idx)=>{
      const el=document.getElementById(id);
      el.classList.remove('active','gold','black');
      if(idx<succ){ el.classList.add('active','gold'); }
    });
    ['ds_f1','ds_f2','ds_f3'].forEach((id,idx)=>{
      const el=document.getElementById(id);
      el.classList.remove('active','gold','black');
      if(idx<fail){ el.classList.add('active','black'); }
    });
  }
  function toggleStar(i, group){
    if(group==='insp'){
      const n = currentStars('insp'); let next = (i<=n)? i-1 : i;
      syncStars(next); save(); return;
    }
    if(group==='ds_success'){
      const n = currentStars('ds_success'); let next = (i<=n)? i-1 : i;
      syncDeathStars(next, currentStars('ds_failure')); save(); return;
    }
    if(group==='ds_failure'){
      const n = currentStars('ds_failure'); let next = (i<=n)? i-1 : i;
      syncDeathStars(currentStars('ds_success'), next); save(); return;
    }
  }

  /* DnD colonne droite uniquement */
  function initRightDnD(){
    const col = document.getElementById('rightCol');

    col.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging = document.querySelector('#rightCol .card.dragging');
      if(!dragging) return;
      const after = getAfter(col, e.clientY);
      if(after == null){ col.appendChild(dragging); }
      else { col.insertBefore(dragging, after); }
    });
    col.addEventListener('drop', saveRightOrder);

    col.querySelectorAll('.card').forEach(card=>{
      const handle = card.querySelector('.drag-handle');
      if(!handle) return;
      card.querySelectorAll('input, textarea, button').forEach(el=> el.setAttribute('draggable','false'));
      handle.addEventListener('mousedown', ()=>{ card.setAttribute('draggable','true'); });
      handle.addEventListener('touchstart', ()=>{ card.setAttribute('draggable','true'); }, {passive:true});
      card.addEventListener('dragstart', ()=>{ card.classList.add('dragging'); });
      card.addEventListener('dragend', ()=>{
        card.classList.remove('dragging');
        card.setAttribute('draggable','false');
        saveRightOrder();
      });
    });

    function getAfter(container, y){
      const els = [...container.querySelectorAll('.card:not(.dragging)')];
      return els.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height/2;
        if(offset < 0 && offset > closest.offset){ return {offset, element: child}; }
        else{ return closest; }
      }, {offset: Number.NEGATIVE_INFINITY}).element;
    }
  }

  function saveRightOrder(){
    const order = [...document.querySelectorAll('#rightCol > .card')].map(c=>c.dataset.cardid);
    localStorage.setItem(RIGHT_ORDER_K, JSON.stringify(order));
  }
  function applySavedRightOrder(){
    let order=null; try{ order = JSON.parse(localStorage.getItem(RIGHT_ORDER_K)); }catch(e){}
    if(!order) return;
    const col = document.getElementById('rightCol');
    const map = {};
    col.querySelectorAll(':scope > .card').forEach(c=> map[c.dataset.cardid]=c);
    order.forEach(id=>{ if(map[id]) col.appendChild(map[id]); });
  }

  /* helpers */
  function val(id){ const el=document.getElementById(id); return el?el.value:''; }
  function setVal(id,v){ const el=document.getElementById(id); if(el){ el.value=v; } }
  function setText(id,t){ const el=document.getElementById(id); if(el){ el.textContent=t; } }
  function int(id,def){ const v=parseInt(val(id)); return isNaN(v)?def:v; }

  /* Listes */
  function addAttack(name='',bonus='',dmg='',desc='',saveNow=true,index=null){
    const host=document.getElementById('attacks');
    const row=document.createElement('div');
    row.className='atk-row';
    row.setAttribute('data-attack','1');
    row.innerHTML=`
      <input class="atk-name" type="text" placeholder="Nom (ex. Dague)" value="${name}" oninput="save()">
      <input class="atk-bonus" type="text" placeholder="+X" value="${bonus}" oninput="save()">
      <input class="atk-dmg" type="text" placeholder="XdY+Z" value="${dmg}" oninput="save()">
      <button class="icon-btn del" title="Supprimer" onclick="this.closest('[data-attack]').remove(); save();">✕</button>
      <textarea class="atk-desc atk-desc" placeholder="Description / effets / conditions" oninput="save()">${desc||''}</textarea>
    `;
    host.appendChild(row);
    if(saveNow) save();
  }
  function addItem(v='',saveNow=true,index=null){
    const host=document.getElementById('inventory');
    const wrap=document.createElement('div');
    wrap.className='list-row';
    const input=document.createElement('input');
    input.type='text'; input.setAttribute('data-item','1'); input.value=v; input.placeholder='Nouvel objet'; input.oninput=save;
    const del=document.createElement('button'); del.className='icon-btn del'; del.textContent='✕'; del.title='Supprimer';
    del.onclick=()=>{ wrap.remove(); save(); };
    wrap.appendChild(input); wrap.appendChild(del);
    host.appendChild(wrap); if(saveNow) save();
  }
  function addFeature(v='',saveNow=true,index=null){
    const host=document.getElementById('features');
    const wrap=document.createElement('div');
    wrap.className='list-row';
    const input=document.createElement('input');
    input.type='text'; input.setAttribute('data-feature','1'); input.value=v; input.placeholder='Nouveau trait / don / capacité'; input.oninput=save;
    const del=document.createElement('button'); del.className='icon-btn del'; del.textContent='✕'; del.title='Supprimer';
    del.onclick=()=>{ wrap.remove(); save(); };
    wrap.appendChild(input); wrap.appendChild(del);
    host.appendChild(wrap); if(saveNow) save();
  }

  /* Export / Import / Reset */
  function exportJSON(){
    const data = JSON.stringify(collect());
    const blob = new Blob([data],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='fiche-dnd-2024.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        localStorage.setItem(K, JSON.stringify(data));
        load();
        setStatus('Import réussi ✅');
      }catch(err){ setStatus('❌ Fichier invalide'); }
    };
    reader.readAsText(file);
  }
  function resetAll(){
    if(confirm('Réinitialiser la fiche (données) ?')){
      localStorage.removeItem(K);
      load();
    }
  }

  window.addEventListener('load', ()=>{
    load();
    document.getElementById('exportBtn').addEventListener('click', exportJSON);
    document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('importInput').click());
    document.getElementById('importInput').addEventListener('change', e=>{
      const f=e.target.files[0]; if(f) importJSON(f);
    });
    document.getElementById('resetBtn').addEventListener('click', resetAll);
  });
</script>
</body>
</html>
